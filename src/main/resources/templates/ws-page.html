<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>WebSocket Chat</title>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
</head>
<body>
<h1>WebSocket Chat</h1>
<input type="text" id="messageInput" placeholder="Type a message..."/>
<button onclick="sendMessage()">Send</button>
<ul id="messages"></ul>

<script type="text/javascript">
  const token = '[[${token}]]'; // Thymeleaf에서 토큰 주입

  const stompClient = new StompJs.Client({
    webSocketFactory: () => new SockJS('/ws-endpoint'),
    connectHeaders: {
      Authorization: 'Bearer ' + token
    },
    debug: function (str) {
      console.log('[STOMP]', str);
    },
    onConnect: function (frame) {
      console.log('✅ Connected:', frame);

      // 구독
      stompClient.subscribe('/topic/room', function (message) {
        const body = JSON.parse(message.body);
        showMessage(body.username + " : " + body.message);
      });
    },
    onStompError: function (frame) {
      console.error('❌ STOMP error', frame.headers['message'], frame.body);
    },
    onWebSocketError: function (event) {
      console.error('❌ WebSocket error', event);
    },
    reconnectDelay: 5000,
  });

  stompClient.activate(); // 연결 시작

  function sendMessage() {
    const message = document.getElementById('messageInput').value;
    stompClient.publish({
      destination: "/app/send",
      body: JSON.stringify({
        username: "유저명",
        message: message
      })
    });
  }

  function showMessage(message) {
    const messages = document.getElementById('messages');
    const li = document.createElement('li');
    li.textContent = message;
    messages.appendChild(li);
  }
</script>
</body>
</html>
